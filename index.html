<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Target Tag â€” Final</title>
<style>
  /* ===== Layout tuned for iPhone 14 portrait ===== */
  :root{
    --bg-a: #ff6b6b;
    --bg-b: #ffd166;
    --panel: rgba(255,255,255,0.06);
    --card: rgba(255,255,255,0.04);
    --muted: rgba(255,255,255,0.9);
    --nav-bg: rgba(7,11,20,0.9);
    --btn-grad: linear-gradient(90deg,#ffd166,#ff7a59);
    --maxw: 460px;
  }
  html,body{
    height:100%;
    margin:0;
    background: linear-gradient(180deg,var(--bg-a),var(--bg-b));
    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
    -webkit-font-smoothing:antialiased;
    color:#fff;
  }
  /* center app and limit width */
  #app{
    max-width:var(--maxw);
    margin:0 auto;
    height:100vh;
    display:flex;
    flex-direction:column;
    box-sizing:border-box;
    position:relative;
    overflow:hidden;
  }

  /* header */
  .top{
    height:64px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 14px;
    backdrop-filter: blur(6px);
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  }
  .title { display:flex; gap:10px; align-items:center; font-size:18px; font-weight:800; color:#071826; }
  .coinPill{
    background: rgba(0,0,0,0.25);
    padding:6px 10px;
    border-radius:999px;
    font-weight:800;
  }

  /* main screen areas: height calc to fit top + nav*/
  .screen {
    display:none;
    padding:10px;
    box-sizing:border-box;
    height: calc(100vh - 64px - 70px - env(safe-area-inset-bottom)); /* top + nav + safe */
    overflow:hidden;
  }
  .screen.active{ display:block; }

  /* Home */
  .home-inner{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    height:100%;
  }
  .logo{
    width:120px;height:120px;border-radius:20px;background:linear-gradient(180deg,#fff6ea,#ffe0b2);display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(0,0,0,0.2);
  }

  .desc{ color:rgba(0,0,0,0.6); text-align:center; max-width:86%; }

  .playBtn{
    width:86%;
    padding:14px;
    border-radius:14px;
    border:none;
    font-weight:900;
    font-size:16px;
    color:#042827;
    cursor:pointer;
    background: var(--btn-grad);
    box-shadow:0 12px 30px rgba(0,0,0,0.15);
  }

  /* game area */
  #gameArea{
    width:100%;
    height:100%;
    border-radius:12px;
    background: linear-gradient(180deg, #062a3b, #04202b);
    position:relative;
    overflow:hidden;
    touch-action:none;
  }
  .hud{
    position:absolute;
    left:12px;
    top:12px;
    z-index:120;
    display:flex;
    gap:8px;
  }
  .hud .stat{
    background: rgba(255,255,255,0.06);
    padding:6px 10px;
    border-radius:10px;
    font-weight:800;
    color:#fff;
  }
  .sessionCoins{ display:none; }

  /* target */
  .target{
    position:absolute;
    width:72px;height:72px;border-radius:999px;display:flex;align-items:center;justify-content:center;
    touch-action:none;
    user-select:none;
    box-shadow:0 12px 24px rgba(0,0,0,0.45);
    transform-origin:center center;
    transition: transform .12s ease, opacity .2s ease;
  }
  .target svg{ width:100%; height:100%; border-radius:999px; display:block; }

  /* shop & locker */
  .panel-card{
    background: var(--card);
    border-radius:12px;
    padding:10px;
    height:100%;
    box-sizing:border-box;
    overflow:hidden;
  }
  .shop-list{
    overflow:auto;
    height:100%;
    padding-right:8px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .shop-item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:8px;
    border-radius:10px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
    border:1px solid rgba(255,255,255,0.02);
  }
  .shop-left{ display:flex; gap:10px; align-items:center; }
  .preview{ width:64px;height:64px;border-radius:10px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#00000022; }
  .shop-info{ max-width:180px; color:rgba(255,255,255,0.95); font-weight:700; font-size:14px }
  .shop-desc{ color:rgba(255,255,255,0.8); font-weight:500; font-size:12px }

  .buyBtn{ padding:8px 10px; border-radius:10px; border:none; font-weight:900; cursor:pointer; background:linear-gradient(90deg,#ffd166,#ff8a65); color:#042827; }

  /* locker grid */
  .locker-grid{ display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start; }

  /* modal */
  .modal-back{ position:fixed; left:0; right:0; top:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:9999; }
  .modal{ width:86%; max-width:420px; background:linear-gradient(180deg,#ffffff11,#00000005); padding:12px;border-radius:12px; color:#fff; }

  /* bottom nav fixed */
  nav.bottom{
    height:70px;
    background:var(--nav-bg);
    display:flex;
    justify-content:space-around;
    align-items:center;
    gap:6px;
    padding-bottom: calc(env(safe-area-inset-bottom));
  }
  .nav-item{ flex:1; text-align:center; font-weight:900; color:rgba(255,255,255,0.85); cursor:pointer; font-size:13px; padding:10px 6px; }
  .nav-item.active{ color:#fff; }

  /* final spacing for iPhone safe area */
  body { padding-bottom: env(safe-area-inset-bottom); }

</style>
</head>
<body>
  <div id="app">
    <div class="top">
      <div class="title">ðŸŽ¯ Target Tag</div>
      <div class="coinPill" id="coinDisplay">Coins: 0</div>
    </div>

    <!-- HOME -->
    <section id="home" class="screen active">
      <div class="home-inner">
        <div class="logo" aria-hidden="true">
          <!-- decorative target -->
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="42" fill="#fff"/>
            <circle cx="50" cy="50" r="34" fill="#2b9cff"/>
            <circle cx="50" cy="50" r="22" fill="#fff"/>
            <circle cx="50" cy="50" r="10" fill="#2b9cff"/>
          </svg>
        </div>
        <div>
          <h2 style="margin:6px 0 4px 0; color:#071826">Tap targets. Earn coins. Buy skins & powerups.</h2>
          <div class="desc">1 coin per 10 points. Legendary & Mythic skins give massive multipliers. Shop has skins & powerups â€” prices shown on buttons.</div>
        </div>

        <div style="flex:1; display:flex; align-items:flex-end; width:100%; justify-content:center;">
          <button id="playBtn" class="playBtn">Play</button>
        </div>
      </div>
    </section>

    <!-- GAME -->
    <section id="game" class="screen">
      <div id="gameArea">
        <div class="hud">
          <div class="stat">Score: <span id="score">0</span></div>
          <div class="stat">Time: <span id="time">0</span></div>
          <div class="stat sessionCoins">Session: <span id="sessionCoins">0</span></div>
        </div>
      </div>
    </section>

    <!-- SHOP -->
    <section id="shop" class="screen">
      <div class="panel-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <button id="shopBack" class="btn ghost">Back</button>
          <div style="font-weight:900">Shop</div>
          <div style="width:64px"></div>
        </div>
        <div class="shop-list" id="shopList" role="list"></div>
      </div>
    </section>

    <!-- LOCKER -->
    <section id="locker" class="screen">
      <div class="panel-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <button id="lockerBack" class="btn ghost">Back</button>
          <div style="font-weight:900">Locker</div>
          <div style="width:64px"></div>
        </div>

        <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
          <div id="previewLarge" style="width:96px; height:96px; border-radius:12px; display:flex; align-items:center; justify-content:center; background:#00000022;"></div>
          <div style="flex:1">
            <div id="previewName" style="font-weight:900">No skin equipped</div>
            <div id="previewDesc" style="color:rgba(255,255,255,0.85); font-size:13px">Equip skins to change targets and activate perks.</div>
          </div>
          <button id="unequip" class="btn ghost">Unequip</button>
        </div>

        <div style="font-weight:900; margin-bottom:8px">Owned Skins</div>
        <div class="locker-grid" id="ownedSkins"></div>

        <div style="font-weight:900; margin-top:12px; margin-bottom:8px">Owned Powerups</div>
        <div class="locker-grid" id="ownedPowerups"></div>
      </div>
    </section>

    <!-- bottom nav -->
    <nav class="bottom">
      <div id="navHome" class="nav-item active">Home</div>
      <div id="navShop" class="nav-item">Shop</div>
      <div id="navLocker" class="nav-item">Locker</div>
      <div id="navPlay" class="nav-item">Play</div>
    </nav>
  </div>

  <!-- modal root -->
  <div id="modalRoot" style="display:none;"></div>

<script>
/* ======================
   FULL GAME IMPLEMENTATION
   Final version per request
   ====================== */

/* ---- Utilities ---- */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const create = (t, cls='') => { const e = document.createElement(t); if(cls) e.className = cls; return e; };

/* ---- Persistent state ---- */
const KEY = 'target-tag-final-v1';
let state = {
  coins: 0,
  ownedSkins: ['default'], // default is built-in red
  equippedSkin: 'default',
  ownedPowerups: {}, // {id:count}
  equippedPowerups: [], // used via locker -> next round
  highscores: [],
};
(function load(){ try{ const r = localStorage.getItem(KEY); if(r){ Object.assign(state, JSON.parse(r)); } }catch(e){ console.warn(e); }})();

function save(){ localStorage.setItem(KEY, JSON.stringify(state)); updateUI(); }

/* ---- DOM refs ---- */
const screens = { home: $('#home'), game: $('#game'), shop: $('#shop'), locker: $('#locker') };
const coinDisplay = $('#coinDisplay');
const scoreEl = $('#score'), timeEl = $('#time'), sessionCoinsEl = $('#sessionCoins');
const gameArea = $('#gameArea');
const shopList = $('#shopList');
const ownedSkinsEl = $('#ownedSkins'), ownedPowerupsEl = $('#ownedPowerups');
const previewLarge = $('#previewLarge'), previewName = $('#previewName'), previewDesc = $('#previewDesc');

const modalRoot = $('#modalRoot');

/* ---- Items config (prices & perks) ---- */
const SKINS = [
  { id:'default', name:'Default (Red)', price:0, desc:'Red & white bullseye (starting skin).', color:'#ff6767', perk: null },
  { id:'common', name:'Common', price:500, desc:'Bright blue & white bullseye. Includes 1 free Coin Frenzy on purchase.', color:'#2b9cff', perk:'free_coin_frenzy' },
  { id:'uncommon', name:'Uncommon', price:1000, desc:'Cool silver rings. Includes 1 free powerup of your choice.', color:'#b8c9d9', perk:'pick1_powerup' },
  { id:'rare', name:'Rare', price:2000, desc:'Bronze rings. Includes 2 free powerups of your choice.', color:'#b08a4b', perk:'pick2_powerups' },
  { id:'epic', name:'Epic', price:3500, desc:'Glossy purple target. Grants permanent 2Ã— coins & 2Ã— score while equipped.', color:'#8b5cf6', perk:'mult2' },
  { id:'legendary', name:'Legendary', price:5000, desc:'Gold & black. Grants permanent 5Ã— coins & 5Ã— score while equipped.', color:'#f6c84d', perk:'mult5' },
  { id:'mythic', name:'Mythic', price:50000, desc:'Shiny Fortnite-style gold. Grants permanent 10Ã— coins & 10Ã— score. Special message on purchase.', color:'#ffd94d', perk:'mult10' },
];

const POWERUPS = [
  { id:'coin_frenzy', name:'Coin Frenzy (20s)', price:200, desc:'Double coins for 20s (one use per round).', short:'2Ã— coins', duration:20 },
  { id:'small_time', name:'Small Time +10s', price:150, desc:'+10 seconds to round length', short:'+10s', duration:10 },
  { id:'big_time', name:'Big Time +25s', price:350, desc:'+25 seconds to round length', short:'+25s', duration:25 },
  { id:'slow_mo', name:'Slow-mo (5s)', price:300, desc:'Slower spawn rate for 5s', short:'Slow-mo', duration:5 },
  { id:'double_points', name:'Double Points (10s)', price:600, desc:'Double score for 10s', short:'2Ã— pts', duration:10 },
];

/* ---- helper lookups ---- */
function findSkin(id){ return SKINS.find(s=>s.id===id); }
function findPowerup(id){ return POWERUPS.find(p=>p.id===id); }

/* ---- UI & Navigation ---- */
function show(screen){
  Object.values(screens).forEach(s => s.classList.remove('active'));
  screens[screen].classList.add('active');
  // nav active classes
  ['navHome','navShop','navLocker','navPlay'].forEach(x => document.getElementById(x).classList.remove('active'));
  if(screen==='home') document.getElementById('navHome').classList.add('active');
  if(screen==='shop') document.getElementById('navShop').classList.add('active');
  if(screen==='locker') document.getElementById('navLocker').classList.add('active');
  if(screen==='game') document.getElementById('navPlay').classList.add('active');
}
$('#navHome').addEventListener('click', ()=> show('home'));
$('#navShop').addEventListener('click', ()=> show('shop'));
$('#navLocker').addEventListener('click', ()=> show('locker'));
$('#navPlay').addEventListener('click', ()=> startRound());
$('#playBtn').addEventListener('click', ()=> startRound());
$('#shopBack').addEventListener('click', ()=> show('home'));
$('#lockerBack').addEventListener('click', ()=> show('home'));
$('#unequip').addEventListener('click', ()=>{
  state.equippedSkin = 'default';
  save();
});

/* ---- Audio & Haptics ---- */
let audioCtx = null;
function ensureAudio(){ if(!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ audioCtx = null; } } }
function beep(freq=600,dur=0.08,g=0.06){ if(!audioCtx) return; const o = audioCtx.createOscillator(); const gr = audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; gr.gain.value=g; o.connect(gr); gr.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+dur); }
function vib(ms=12){ if(navigator.vibrate) navigator.vibrate(ms); }

/* init audio on first touch to satisfy iOS */
document.addEventListener('touchstart', function once(){ ensureAudio(); document.removeEventListener('touchstart', once); }, {passive:true});

/* ---- Rendering Shop & Locker ---- */
function renderShop(){
  shopList.innerHTML = '';
  // Skins
  const skHead = create('div','shop-item'); skHead.style.justifyContent='center'; skHead.innerHTML = '<strong style="font-size:15px">Skins</strong>'; shopList.appendChild(skHead);
  SKINS.forEach(s=>{
    const item = create('div','shop-item');
    const left = create('div','shop-left');
    const preview = create('div','preview'); preview.innerHTML = renderSkinSVG(s.id);
    const info = create('div'); info.innerHTML = `<div class="shop-info">${s.name}</div><div class="shop-desc">${s.desc}</div>`;
    left.appendChild(preview); left.appendChild(info);
    const btn = create('button','buyBtn');
    btn.dataset.id = s.id;
    if(state.ownedSkins.includes(s.id) || s.price===0){
      btn.textContent = 'Owned';
      btn.disabled = true;
      btn.style.opacity = 0.7;
    } else {
      btn.textContent = `Buy ${s.price}`;
      btn.addEventListener('click', ()=> onBuySkin(s));
    }
    item.appendChild(left); item.appendChild(btn);
    shopList.appendChild(item);
  });

  // Powerups
  const pHead = create('div','shop-item'); pHead.style.justifyContent='center'; pHead.innerHTML = '<strong style="font-size:15px">Powerups</strong>'; shopList.appendChild(pHead);
  POWERUPS.forEach(p=>{
    const item = create('div','shop-item');
    const left = create('div','shop-left');
    const preview = create('div','preview'); preview.innerHTML = `<div style="font-weight:900">${p.short}</div>`;
    const info = create('div'); info.innerHTML = `<div class="shop-info">${p.name}</div><div class="shop-desc">${p.desc}</div>`;
    left.appendChild(preview); left.appendChild(info);
    const btn = create('button','buyBtn');
    btn.dataset.id = p.id;
    btn.textContent = `Buy ${p.price}`;
    btn.addEventListener('click', ()=> onBuyPowerup(p));
    item.appendChild(left); item.appendChild(btn);
    shopList.appendChild(item);
  });
}

function renderLocker(){
  // preview
  const eq = state.equippedSkin || 'default';
  previewLarge.innerHTML = renderSkinSVG(eq);
  previewName.textContent = findSkin(eq)?.name || 'Default';
  previewDesc.textContent = findSkin(eq)?.desc || '';

  // owned skins grid
  ownedSkinsEl.innerHTML = '';
  state.ownedSkins.forEach(id=>{
    const s = findSkin(id) || {name:id};
    const card = create('div','card'); card.style.width='84px'; card.style.padding='8px'; card.style.cursor='pointer'; card.innerHTML = renderSkinSVG(id) + `<div style="font-size:12px;margin-top:6px;text-align:center">${s.name}</div>`;
    card.addEventListener('click', ()=>{
      state.equippedSkin = id;
      save();
      renderLocker();
      refreshPreview();
      beep(1200,0.06,0.06); vib(18);
    });
    ownedSkinsEl.appendChild(card);
  });

  // owned powerups
  ownedPowerupsEl.innerHTML = '';
  Object.keys(state.ownedPowerups).forEach(pid=>{
    const cnt = state.ownedPowerups[pid];
    if(!cnt) return;
    const p = findPowerup(pid);
    const card = create('div','card');
    card.style.width='140px'; card.style.padding='8px'; card.style.textAlign='center';
    card.innerHTML = `<div style="font-weight:800">${p.name}</div><div class="muted" style="font-size:13px">${p.desc}</div><div style="margin-top:6px;font-weight:900">${cnt} owned</div><button class="btn ghost" style="margin-top:8px">Use in next round</button>`;
    const ubtn = card.querySelector('button');
    ubtn.addEventListener('click', ()=>{
      if(state.ownedPowerups[pid] > 0){
        state.ownedPowerups[pid]--;
        state.equippedPowerups.push(pid);
        save();
        renderLocker();
        beep(900,0.08,0.06); vib(20);
        alert(`${p.name} equipped for next round`);
      }
    });
    ownedPowerupsEl.appendChild(card);
  });
}

/* ---- render skin svg preview (string) ---- */
function renderSkinSVG(id){
  const s = findSkin(id) || findSkin('default');
  // create simple bullseye SVG with color
  const outer = s.color || '#ff6767';
  const mid = '#fff';
  const inner = s.color || '#ff6767';
  const center = (id === 'legendary') ? '#000' : (id === 'mythic' ? '#000' : s.color);
  return `<svg viewBox="0 0 100 100" width="56" height="56" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="48" fill="${outer}" />
    <circle cx="50" cy="50" r="32" fill="${mid}" />
    <circle cx="50" cy="50" r="18" fill="${inner}" />
    <circle cx="50" cy="50" r="8" fill="${center}" />
  </svg>`;
}

/* ---- Buying flows ---- */
function onBuySkin(skin){
  openModal(`
    <div class="modal">
      <h3>Buy ${skin.name}?</h3>
      <div class="muted">${skin.desc}</div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="confirmBuy" class="big" style="flex:1; padding:10px; border-radius:10px; background:linear-gradient(90deg,#ffd166,#ff8a65); font-weight:900;">Buy ${skin.price}</button>
        <button id="cancelBuy" class="btn ghost" style="flex:1;">Cancel</button>
      </div>
    </div>
  `);
  $('#confirmBuy').addEventListener('click', ()=>{
    if(state.coins < skin.price){ alert('Not enough coins'); closeModal(); return; }
    state.coins -= skin.price;
    if(!state.ownedSkins.includes(skin.id)) state.ownedSkins.push(skin.id);
    // apply perks based on skin.perk
    if(skin.perk === 'free_coin_frenzy'){
      state.ownedPowerups['coin_frenzy'] = (state.ownedPowerups['coin_frenzy']||0) + 1;
      alert('You received a free Coin Frenzy!');
    } else if(skin.perk === 'pick1_powerup'){
      closeModal();
      choosePowerups(1, (chosen)=>{
        if(!chosen || chosen.length===0){ save(); renderShop(); return; }
        chosen.forEach(id => { state.ownedPowerups[id] = (state.ownedPowerups[id]||0) + 1; });
        alert('Free powerup granted!');
      });
      state.ownedSkins.push(skin.id);
    } else if(skin.perk === 'pick2_powerups'){
      closeModal();
      choosePowerups(2, (chosen)=>{
        chosen.forEach(id => { state.ownedPowerups[id] = (state.ownedPowerups[id]||0) + 1; });
        alert('Free powerups granted!');
      });
      state.ownedSkins.push(skin.id);
    } else {
      // none or multiplier perks handled on equip time
    }
    // mythic special message
    if(skin.id === 'mythic'){
      alert("You've caught up with us! There are no new cosmetics here yet but stay tuned for more updates!");
    }
    // auto-equip purchased skin for convenience
    state.equippedSkin = skin.id;
    save();
    closeModal();
    refreshAll();
  });
  $('#cancelBuy').addEventListener('click', ()=> closeModal());
}

function onBuyPowerup(powerup){
  openModal(`
    <div class="modal">
      <h3>Buy ${powerup.name}?</h3>
      <div class="muted">${powerup.desc}</div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="confirmBuyP" class="big" style="flex:1; padding:10px; border-radius:10px; background:linear-gradient(90deg,#ffd166,#ff8a65); font-weight:900;">Buy ${powerup.price}</button>
        <button id="cancelBuyP" class="btn ghost" style="flex:1;">Cancel</button>
      </div>
    </div>
  `);
  $('#confirmBuyP').addEventListener('click', ()=>{
    if(state.coins < powerup.price){ alert('Not enough coins'); closeModal(); return; }
    state.coins -= powerup.price;
    state.ownedPowerups[powerup.id] = (state.ownedPowerups[powerup.id]||0) + 1;
    save();
    closeModal();
    refreshAll();
    beep(900,0.08); vib(20);
  });
  $('#cancelBuyP').addEventListener('click', ()=> closeModal());
}

/* helper: choose powerups when skin gives free selection */
function choosePowerups(count, cb){
  const choices = POWERUPS.map(p=>`<div style="padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);margin-bottom:8px;"><strong>${p.name}</strong><div style="font-size:13px">${p.desc}</div><button data-pid="${p.id}" style="margin-top:6px;padding:8px;border-radius:8px;background:linear-gradient(90deg,#ffd166,#ff8a65);border:none;font-weight:900">Choose</button></div>`).join('');
  openModal(`<div class="modal"><h3>Pick ${count} powerup(s)</h3><div class="muted">Choose ${count} powerup(s) to receive for free.</div><div style="margin-top:10px">${choices}</div><div style="margin-top:8px"><button id="donePick" class="btn ghost">Done</button></div></div>`);
  const picked = [];
  $$('.modal [data-pid]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const pid = e.currentTarget.dataset.pid;
      if(picked.includes(pid)) return;
      picked.push(pid);
      e.currentTarget.textContent = 'Selected';
      e.currentTarget.disabled = true;
      if(picked.length === count){
        // grant and finish
        picked.forEach(id => state.ownedPowerups[id] = (state.ownedPowerups[id]||0) + 1);
        save();
        closeModal();
        cb(picked);
      }
    });
  });
  $('#donePick').addEventListener('click', ()=> { closeModal(); cb(picked); });
}

/* ---- Modal helpers ---- */
function openModal(html){
  modalRoot.innerHTML = '';
  modalRoot.style.display = 'block';
  const back = create('div'); back.className = 'modal-back';
  const wrap = create('div'); wrap.className='modal';
  wrap.innerHTML = html;
  back.appendChild(wrap);
  modalRoot.appendChild(back);
  back.addEventListener('click', (e)=>{ if(e.target===back) closeModal(); });
}
function closeModal(){ modalRoot.innerHTML=''; modalRoot.style.display = 'none'; }

/* ---- UI refresh ---- */
function refreshAll(){
  renderShop();
  renderLocker();
  applyEquippedMultipliers();
  updateUI();
}
function updateUI(){
  coinDisplay.textContent = `Coins: ${state.coins}`;
  // preview panel
  const eq = state.equippedSkin || 'default';
  previewLarge.innerHTML = renderSkinSVG(eq);
  previewName.textContent = findSkin(eq)?.name || 'Default';
  previewDesc.textContent = findSkin(eq)?.desc || '';
}

/* ---- Multipliers from equipped skin ---- */
let permanent = { score:1, coins:1 };
function applyEquippedMultipliers(){
  const eq = state.equippedSkin;
  permanent.score = 1; permanent.coins = 1;
  if(eq === 'epic'){ permanent.score = 2; permanent.coins = 2; }
  if(eq === 'legendary'){ permanent.score = 5; permanent.coins = 5; }
  if(eq === 'mythic'){ permanent.score = 10; permanent.coins = 10; }
}

/* ---- Game runtime ---- */
const CONFIG = { baseSpawn: 900, targetLifetime:1600, basePoints:10, defaultRound:30 };
let runtime = {
  running:false, score:0, timeLeft:0, spawnRef:null, tickRef:null, hits:[], pointsPool:0, sessionCoins:0,
  active:{ coinFrenzy:false, coinFrenzyRemaining:0, doublePts:false, doublePtsRemaining:0, slowMo:false, slowMoRemaining:0 }
};

function spawnOne(){
  if(!runtime.running) return;
  const size = 72;
  const el = create('div','target');
  el.style.width = size+'px'; el.style.height = size+'px';
  const x = Math.random() * Math.max(0, gameArea.clientWidth - size);
  const y = Math.random() * Math.max(0, gameArea.clientHeight - size);
  el.style.left = x+'px'; el.style.top = y+'px';
  // inner svg based on equipped skin
  el.innerHTML = getTargetSVG(state.equippedSkin || 'default');
  gameArea.appendChild(el);
  // animate in
  el.style.transform = 'scale(0.98)'; el.style.opacity = '1';
  // spawn sound
  ensureAudio(); beep(520,0.06,0.02); 
  // remove after lifetime
  const life = setTimeout(()=>{ if(el.parentNode){ el.remove(); } }, CONFIG.targetLifetime);
  // handle hit
  const onHit = (ev) => {
    ev.preventDefault(); ev.stopPropagation();
    if(!runtime.running) return;
    // prevent double
    el.removeEventListener('click', onHit);
    el.removeEventListener('touchstart', onHit);
    clearTimeout(life);
    // points
    const multScore = permanent.score * (runtime.active.doublePts?2:1);
    const pts = CONFIG.basePoints * multScore;
    runtime.score += pts;
    scoreEl.textContent = runtime.score;
    // coins: 1 coin per 10 points, multiplied by permanent & active coin multipliers
    runtime.pointsPool += pts;
    const coinMult = permanent.coins * (runtime.active.coinFrenzy?2:1);
    let coinsGained = 0;
    while(runtime.pointsPool >= 10){
      runtime.pointsPool -= 10;
      coinsGained += coinMult;
    }
    if(coinsGained>0){
      state.coins += coinsGained;
      runtime.sessionCoins += coinsGained;
      save();
    }
    runtime.hits.push(Date.now());
    // hit fx
    ensureAudio(); beep(1200,0.06,0.06); vib(12);
    el.style.transform = 'scale(1.3)'; el.style.opacity = 0;
    setTimeout(()=>{ if(el.parentNode) el.remove(); }, 160);
  };
  el.addEventListener('click', onHit);
  el.addEventListener('touchstart', onHit, {passive:false});
}

/* spawn loop considering slow-mo */
function spawnLoopStart(){
  clearInterval(runtime.spawnRef);
  let interval = CONFIG.baseSpawn;
  if(runtime.active.slowMo) interval *= 1.6;
  runtime.spawnRef = setInterval(spawnOne, interval);
}
function spawnLoopStop(){ clearInterval(runtime.spawnRef); runtime.spawnRef = null; }

/* Round control */
function startRound(){
  ensureAudio();
  // apply equipped powerups queued from locker
  // initialize runtime
  runtime.running = true; runtime.score = 0; runtime.hits = []; runtime.pointsPool = 0; runtime.sessionCoins = 0;
  runtime.active = { coinFrenzy:false, coinFrenzyRemaining:0, doublePts:false, doublePtsRemaining:0, slowMo:false, slowMoRemaining:0 };
  applyEquippedMultipliers();
  // time: base default + any equipped small/big time powerups from state.equippedPowerups
  runtime.timeLeft = CONFIG.defaultRound;
  if(Array.isArray(state.equippedPowerups) && state.equippedPowerups.length){
    state.equippedPowerups.forEach(pid=>{
      if(pid==='small_time') runtime.timeLeft += 10;
      if(pid==='big_time') runtime.timeLeft += 25;
      if(pid==='double_points'){ runtime.active.doublePts = true; runtime.active.doublePtsRemaining = 10; }
      if(pid==='slow_mo'){ runtime.active.slowMo = true; runtime.active.slowMoRemaining = 5; }
      if(pid==='coin_frenzy'){ runtime.active.coinFrenzy = true; runtime.active.coinFrenzyRemaining = 20; }
    });
    state.equippedPowerups = []; save();
  }
  scoreEl.textContent = 0; timeEl.textContent = runtime.timeLeft; sessionCoinsEl.textContent = 0;
  // show game
  show('game');
  // clear any targets
  $$('.target', gameArea).forEach(t=>t.remove());
  // start spawn
  spawnLoopStart();
  // tick
  runtime.tickRef = setInterval(()=>{
    runtime.timeLeft--;
    // decrement active durations
    if(runtime.active.coinFrenzy){ runtime.active.coinFrenzyRemaining--; if(runtime.active.coinFrenzyRemaining <= 0) runtime.active.coinFrenzy = false; }
    if(runtime.active.doublePts){ runtime.active.doublePtsRemaining--; if(runtime.active.doublePtsRemaining <= 0) runtime.active.doublePts = false; }
    if(runtime.active.slowMo){ runtime.active.slowMoRemaining--; if(runtime.active.slowMoRemaining <= 0) runtime.active.slowMo = false; }
    // if slow-mo changes, restart spawn with new rate
    spawnLoopStart();
    timeEl.textContent = runtime.timeLeft;
    if(runtime.timeLeft <= 0) endRound();
  }, 1000);
}

function endRound(){
  if(!runtime.running) return;
  runtime.running = false;
  clearInterval(runtime.spawnRef); clearInterval(runtime.tickRef);
  // remove targets
  $$('.target', gameArea).forEach(t=>t.remove());
  // compute avg time between clicks
  let avg = 'â€”';
  if(runtime.hits.length >= 2){
    const diffs = [];
    for(let i=1;i<runtime.hits.length;i++) diffs.push(runtime.hits[i]-runtime.hits[i-1]);
    avg = (Math.round((diffs.reduce((a,b)=>a+b,0)/diffs.length)/10)/100) + 's';
  }
  // add highscore record
  state.highscores = state.highscores || [];
  state.highscores.unshift({score: runtime.score, coins: runtime.sessionCoins, date: Date.now()});
  state.highscores = state.highscores.slice(0,10);
  save();
  // show modal summary
  openModal(`
    <div class="modal">
      <h3>Round Complete</h3>
      <div class="muted">Score: <strong>${runtime.score}</strong></div>
      <div class="muted">Coins earned: <strong>${runtime.sessionCoins}</strong></div>
      <div class="muted">Average click gap: <strong>${avg}</strong></div>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="again" class="big-btn" style="flex:1">Play Again</button>
        <button id="homeBtn" class="btn ghost" style="flex:1">Home</button>
      </div>
    </div>
  `);
  $('#again').addEventListener('click', ()=> { closeModal(); startRound(); });
  $('#homeBtn').addEventListener('click', ()=> { closeModal(); show('home'); });
}

/* ---- Helper to get target inline SVG for equipped skin ---- */
function getTargetSVG(skinId){
  const s = findSkin(skinId) || findSkin('default');
  const outer = s.color || '#ff6767';
  const mid = '#fff';
  const inner = s.color;
  let center = (skinId === 'legendary' || skinId === 'mythic') ? '#000' : s.color;
  return `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50"cy="50"r="48" fill="${outer}"/><circle cx="50"cy="50"r="32" fill="${mid}"/><circle cx="50"cy="50"r="18" fill="${inner}"/><circle cx="50"cy="50"r="8" fill="${center}"/></svg>`;
}

/* ---- Shop/Locker initial render & UI refresh ---- */
function refreshAll(){
  renderShop();
  renderLocker();
  applyEquippedMultipliers();
  updateUI();
}
renderShop(); renderLocker(); updateUI();

/* ---- Run UI updates periodically ---- */
setInterval(()=>{ updateUI(); }, 1500);

/* ---- Some debug exposure ---- */
window._TT = { state, refreshAll, startRound };

/* ---- ensure UI fits iPhone 14: use CSS; bottom nav is fixed and internal lists scroll ---- */

/* ---- Save on page unload ---- */
window.addEventListener('beforeunload', save);

</script>
</body>
</html>



